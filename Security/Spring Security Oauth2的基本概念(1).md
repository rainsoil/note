# Spring Security Oauth2的基本概念

## 1. 什么是认证

在移动互联网时代,我们经常要登陆各种各样的软件, 比如微信、支付宝、淘宝等,我们拿登陆淘宝来举例子来说明一下认证的基本概念, 当我们在初次使用淘宝的时候, 需要注册为淘宝的会员,然后输入账号密码登录淘宝,这个使用账号密码登陆淘宝的过程就是认证. 

系统 为什么要认证呢? 

认证是为了保护系统的隐私数据与资源, 用户的身份合法才可以访问该系统的资源. 

**认证:** 用户认证就是判断一个用户的身份是否合法的过程,用户去访问系统资源时系统要求验证用户的身份信息, 身份合法之后才可以继续访问,不合法则会拒绝. 常见的用户身份认证的方式有: 用户名密码认证、二维码登陆、手机短信登陆、指纹认证等. 



## 2. 什么是会话

当用户认证通过后,为了避免用户的每次操作都需要认证, 于是将用户的信息保存到会话中，会话就是系统为了保持当前用户的登陆状态所提供的机制,常见的有基于session的和基于token的. 

### 基于session的认证方式

他的交互流程是,用户认证成功后,在服务端生成用户相关的数据保存在`session`(当前会话中), 发给客户端的`session_id` 存放到`cookie` 中, 这样用户客户端请求时带上`session_id` 就可以验证服务器是否存在`session`数据 ,以此完成用户的合法校验,当用户退出系统或者`session` 过期销毁时,客户端的`session_id` 也就无效了. 

![image-20200724143422663](Spring%20Security%20Oauth2%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.assets/image-20200724143422663.png)



### 基于`token`方式如下图

他的交互流程是, 用户认证成功后,服务端生成一个`token` 发给客户端,客户端可以放到`cookie` 或者`localStorage` 等存储中,每次请求带上`token`, 服务端收到`token`后即可以确认用户的身份. 

![image-20200724143433746](Spring%20Security%20Oauth2%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.assets/image-20200724143433746.png)







##  1.3. 什么是授权

还拿淘宝来举例子,淘宝登陆成功后就可以使用购物车,订单之类的功能,但是没有绑定支付宝的用户是无法进行购买的,订单、购物车这些都属于功能资源,用户有购物车、下订单的功能的权限,这种根据用户的权限来控制用户使用资源的过程就是授权. 

为什么要授权呢? 

认证是为了保证用户身份的合法性, 授权则是为了更细粒度的对隐私数据进行划分,授权是在用户认证之后发生的, 为了控制不同的用户能够访问不同的资源. 

**授权:** 授权是用户认证通过根据用户的权限来控制用户访问资源的过程,拥有资源的访问权限则正常访问,没有权限则拒绝访问. 



### 1.3.1 授权的数据模式

如何进行授权即如何对用户的访问资源进行控制,首先需要学习一下授权相关的数据模型. 

- 主体(`Subject`)

  > 一般是指用户,也可以说程序,需要访问系统中的资源

- 资源(`Resource`)

  > 如系统资源、页面、按钮、代码方法、系统商品信息、系统订单信息等, 系统菜单、页面、按钮等属于系统功能资源, 对于web系统的每个功能资源通常对应一个URL; 系统商品信息、系统订单信息属于实体资源(数据资源), 实体资源由资源类型和资源实例组成,

- 权限/许可(`Permission`)

  > 规定了用户对资源的操作许可,权限离开资源没有意义. 







### 1.3.2 授权的方式 RBAC

#### 1.3.2.1 基于角色的访问控制

`RBAC` 基于角色的访问控制(`Role-Based Access Control`)是按照角色进行授权,比如: 主体的角色为总经理,可以直接查询企业运营报表,查询员工工资信心等.判断逻辑授权代码表示为:

```java
if(主体.hasRole("总经理角色id")){
查询工资
}

```



如果查询工作所需要的角色变化为总经理和部门经理,此时就需要修改判断逻辑为"判断用户的角色是否为总经理或者部门经理", 修改代码如下:

```java
if(主体.hasRole("总经理角色id") || 主体.hasRole("部门经理角色id")){
查询工资
}
```

根据上面的例子发现,当需要修改角色的权限时就需要修改代码授权的相关代码,系统可扩展性差. 



#### 1.3.2.2 基于资源的访问控制

`RBAC` 基于资源的访问控制(`Resource-Based Access Control`) 是按资源(或权限)进行授权,比如: 用户必须具有查询工资的权限才可以查询员工工资信息等,授权代码可以表示为：

```java
if(主体.hasPermission("查询工资权限标识")){
查询工资
}
```

优点: 系统设计时定义好查询工资的权限标识,即使查询工资所需要的角色变化为总经理或者部门经理,也不需要修改授权代码, 系统可扩展性强. 







